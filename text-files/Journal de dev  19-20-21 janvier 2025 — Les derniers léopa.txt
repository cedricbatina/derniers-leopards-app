Journal de dev â€” Les derniers lÃ©opards app
2026-01-19 â€” i18n (Nuxt i18n) : rÃ©solution des chemins â€œi18n/i18nâ€

SymptÃ´me

Nitro/Vite Ã©chouait Ã  charger les locales avec des chemins du type .../i18n/locales/locales/fr.json ou .../i18n/i18n/locales/fr.json.

Cause

langDir + file (ou structure de dossiers) aboutissaient Ã  une concatÃ©nation involontaire (dossier locales â€œdoublÃ©â€).

DÃ©cision / Fix

Standardisation : les traductions sont dans un dossier racine ./locales/.

Config i18n ramenÃ©e Ã  :

langDir: 'locales/'

locales: [{ file: 'fr.json' }, { file: 'en.json' }]

lazy: true

vueI18n: './i18n.config.ts' (chemin explicite)

nuxt.config

RÃ©sultat

Disparition des erreurs ENOENT sur fr.json / en.json.

2026-01-20 â€” CSS / Design system : intÃ©gration Tailwind v4 + Nuxt UI

Objectif

Avoir un design system stable, cohÃ©rent et maintenable (tokens + composants utilitaires).

Actions

Mise en place dâ€™un assets/css/main.css basÃ© sur :

tokens RGB (light/dark),

@theme pour exposer les couleurs Ã  Tailwind,

composants (card, btn, input, table, topbar, etc.).

RÃ©sultat

Style cohÃ©rent + base â€œappâ€ prÃªte pour les Ã©crans suivants.

2026-01-21 â€” Correction runtime Tailwind : Cannot apply unknown utility class container-app

SymptÃ´me

Erreur serveur : Cannot apply unknown utility class container-app.

Cause

Tailwind ne permet pas (dans ce contexte) @apply sur une classe custom comme si câ€™Ã©tait une utility (@apply container-app ...)

main

.

Fix

Remplacer @apply container-app ... par les utilities rÃ©elles directement dans .page.

RÃ©sultat

La page sâ€™affiche correctement (fin du crash CSS) et on peut reprendre lâ€™UI.



ğŸ§­ Journal de dÃ©veloppement â€” Auth & User System

Projet : derniers-leopards-app
PÃ©riode : ~3 jours

1) Stabilisation de lâ€™authentification (fondations)
Stack

Nuxt 4 (SSR, Nitro preset Vercel)

Auth par JWT :

access_token (court, cookie HttpOnly)

refresh_token (long, cookie HttpOnly)

Sessions persistÃ©es en DB (user_sessions)

Emails transactionnels (Brevo / SMTP Ã  finaliser)

Tables clÃ©s

users

roles

user_roles (RBAC multi-rÃ´les)

user_sessions

auth_tokens (verify_email, reset_password)

2) Refonte complÃ¨te de la table users
Nouveaux champs ajoutÃ©s (base â€œproâ€ dÃ¨s le dÃ©part)

account_type : individual | pro

IdentitÃ© :

first_name, last_name

organization_name

display_name

username

Profil :

profession

avatar_url

bio

website

PrÃ©fÃ©rences :

locale

timezone

SÃ©curitÃ© / conformitÃ© :

terms_accepted_at

marketing_opt_in

Statut :

status (pending, active, suspended, deleted)

email_verified_at

ğŸ‘‰ Objectif : Ã©viter toute migration lourde plus tard, supporter comptes particuliers & pros dÃ¨s maintenant.

3) RBAC propre (abandon du mono-rÃ´le)
DÃ©cision

Source de vÃ©ritÃ© = user_roles

users.role conservÃ© uniquement comme fallback legacy

Tables

roles : user, editor, admin

user_roles : Nâ€“N (assignation propre, extensible)

4) Flux Auth complets et verrouillÃ©s
Register

POST /api/auth/register

CrÃ©ation utilisateur en pending

Insertion profil complet (si fourni)

Assignation du rÃ´le user via user_roles

GÃ©nÃ©ration token verify_email

Envoi email aprÃ¨s COMMIT

Verify email

GET /api/auth/verify-email?token=â€¦

Marque :

auth_tokens.used_at

users.email_verified_at

users.status = active

Redirection front :

/verify-email â†’ /verify-email/success

Login

Refus si :

status â‰  active

email non vÃ©rifiÃ©

CrÃ©ation session persistÃ©e (user_sessions)

Rotation propre refresh token

Cookies HttpOnly posÃ©s

Refresh

VÃ©rification session valide

Rotation refresh token

RÃ©vocation ancienne session

Nouveau access token

Logout

Suppression cookies

Pas de dÃ©pendance cÃ´tÃ© front

Forgot / Reset password

Token reset_password stockÃ© en DB (hashÃ©)

RÃ©vocation des sessions actives aprÃ¨s reset

5) Nettoyage des utilitaires (server/utils)
Clarification stricte des responsabilitÃ©s

utils/jwt.js
â†’ signAccessToken, verifyAccessToken, signRefreshToken, verifyRefreshToken

utils/password.js
â†’ hashPassword, verifyPassword

utils/tokens.js
â†’ randomTokenHex, sha256Hex, safeEqualHex

utils/auth.js
â†’ cookies, helpers DB (createSession, findUserByEmail, etc.)

ğŸ‘‰ Suppression des imports ambigus (verifyAccessToken / sha256Hex mal placÃ©s).

6) /api/auth/me = source de vÃ©ritÃ© front
DonnÃ©es retournÃ©es

IdentitÃ© complÃ¨te

Profil enrichi

roles (array)

role primaire dÃ©duit (admin > editor > user)

account_type

ğŸ‘‰ Le front ne devine rien, il consomme.

7) Store Pinia (auth.store.js)

fetchMe() au dÃ©marrage navigateur

isAuthed dÃ©rivÃ© de user.id

Getters :

roles

isAdmin

isEditor

Actions :

login, logout, register

forgotPassword, resetPassword

SSR prÃªt (headers injectables plus tard).

8) Refonte du composant UserInlineCard
RÃ¨gles finales (validÃ©es)
Titre principal

Compte Pro â†’ organization_name

Particulier â†’ first_name + last_name

Fallback â†’ display_name â†’ username â†’ email

Sous-titre

Pro â†’ display_name (ou email)

Individual â†’ display_name / username

UI

Avatar (image ou initiales)

Badges :

rÃ´le (admin / editor / user)

type de compte (Pro / Particulier)

Aucun champ â€œbrutâ€ affichÃ© (tout passe par i18n)

9) DÃ©cisions UX / Produit

Les infos profession / bio / site iront dans une page profil dÃ©diÃ©e

La home deviendra une landing page gÃ©nÃ©rique (multi-livres, auteurs, crÃ©ateurs)

Le livre Les derniers lÃ©opards nâ€™est plus codÃ© en dur

10) Ã‰tat actuel
âœ”ï¸ Ce qui est stable

Auth complÃ¨te et cohÃ©rente

DB prÃªte pour montÃ©e en charge

RBAC propre

UI auth lisible et pro

â­ï¸ Prochaines Ã©tapes (nouveau chat)

Page Profil utilisateur (lecture / Ã©dition)

Page Account settings (email, password, sessions)

Landing page publique

ACL fine sur contenus (livres, scÃ¨nes, etc.)